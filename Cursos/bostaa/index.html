<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="/home/cursosCSS/cursos.css">
    <style>
        .section-box {
            min-height: 350px;
            padding: 2rem;
        }
    </style>
    <title>Ensino de Chinelo</title>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="../../home/index.html">Ensino de Chinelo</a>
                <a class="navbar-brand" href="../../login/login.html">Entrar</a>
            </div>
        </nav>
    </header>

    <div class="sidebar-wrapper position-relative">
        <div class="sidebar d-flex flex-column p-2" id="sidebar">
            <a href="../../home/index.html" class="nav-link"><i class="bi bi-house-door"></i><span> Início</span></a>
            <a href="#" class="nav-link"><i class="bi bi-person"></i><span> Perfil</span></a>
            <a href="#" class="nav-link"><i class="bi bi-gear"></i><span> Configurações</span></a>
        </div>

        <button class="btn btn-dark toggle-btn" id="toggleBtn">☰</button>
    </div>

    <!-- Conteúdo principal -->
    <div id="mainContent" class="container-fluid mt-4 px-4">
        <div class="row text-center mb-4">
            <div class="col-md-4">
                <div class="border rounded bg-light section-box">
                    <h4>Apresentação do Curso</h4>
                    <p>Descrição geral do curso, objetivos e estrutura.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded bg-light section-box text-start">
                    <h4 class="text-center">Exercícios</h4>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-center">Exercícios</h4>
                        <button id="adicionarCapituloBtn" class="btn btn-primary btn-sm">Adicionar Capítulo</button>
                    </div>

                    <div class="accordion" id="accordionExercicios">



                    </div>

                </div>
            </div>

            <div class="col-md-4">
                <div class="border rounded bg-light section-box">
                    <h4>Artigos</h4>
                    <p>Leituras complementares e materiais de apoio.</p>
                </div>
            </div>
        </div>

        <!-- Seção de vídeos com miniatura -->
        <div class="row">
            <div class="col-12">
                <div class="p-4 border rounded bg-light">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-center">Vídeos</h4>
                        <button id="adicionarCapituloVideoBtn" class="btn btn-primary btn-sm">Adicionar
                            Capítulo</button>
                    </div>
                    <p>Aqui você pode assistir aos vídeos organizados por capítulos.</p>

                    <div class="accordion" id="accordionVideos">





                    </div>

                </div>
            </div>
        </div>


    </div>

    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.querySelectorAll('.video-wrapper').forEach(wrapper => {
            const videoId = wrapper.getAttribute('data-video-id');
            const title = wrapper.querySelector('.video-title');
            const thumbnail = wrapper.querySelector('.video-thumbnail');

            const loadVideo = () => {
                wrapper.innerHTML = `
                    <iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}?autoplay=1"
                        title="Vídeo YouTube" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen>
                    </iframe>
                `;
            };

            title.addEventListener('click', loadVideo);
            thumbnail.addEventListener('click', loadVideo);
        });

        document.getElementById('adicionarCapituloBtn').addEventListener('click', () => {
            const titulo = prompt("Digite o nome do novo capítulo:");
            if (!titulo) return;

            const nomeCurso = window.location.pathname.split('/')[2]; // "/Cursos/NOME/index.html"

            fetch(`http://localhost:3000/api/cursos/${nomeCurso}/adicionar-capitulo-exercicio`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titulo })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.mensagem || "Capítulo criado!");
                    location.reload(); // Recarrega a página para atualizar o accordion
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro ao criar capítulo");
                });
        });
        document.getElementById('adicionarCapituloVideoBtn').addEventListener('click', () => {
            const titulo = prompt("Digite o nome do novo capítulo de vídeo:");
            if (!titulo) return;

            const nomeCurso = window.location.pathname.split('/')[2];

            fetch(`http://localhost:3000/api/cursos/${nomeCurso}/adicionar-capitulo-video`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titulo })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.mensagem || "Capítulo de vídeo criado!");
                    location.reload();
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro ao criar capítulo de vídeo");
                });
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('submit', function (e) {
                if (e.target.classList.contains('upload-form')) {
                    e.preventDefault();

                    const form = e.target;
                    const capituloIndex = form.dataset.capituloIndex;
                    const nomeCurso = window.location.pathname.split('/')[2];

                    const formData = new FormData(form);

                    fetch(`http://localhost:3000/api/cursos/${nomeCurso}/capitulo-exercicio/${capituloIndex}/upload`, {
                        method: 'POST',
                        body: formData
                    })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.mensagem || "Exercício enviado!");
                            location.reload();
                        })
                        .catch(err => {
                            console.error(err);
                            alert("Erro ao enviar exercício");
                        });
                }
            });

            const nomeCurso = window.location.pathname.split('/')[2]; // /Cursos/NOME/index.html

            fetch(`http://localhost:3000/api/cursos/${nomeCurso}`)
                .then(res => res.json())
                .then(curso => {
                    const accordion = document.getElementById('accordionExercicios');
                    accordion.innerHTML = ''; // Limpa os capítulos estáticos

                    curso.capitulosExercicios?.forEach((capitulo, index) => {
    const id = `collapseEx${index}`;
    const headerId = `headingEx${index}`;

    accordion.innerHTML += `
  <div class="accordion-item">
    <h2 class="accordion-header" id="${headerId}">
      <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse"
        data-bs-target="#${id}" aria-expanded="${index === 0}" aria-controls="${id}">
        ${capitulo.titulo}
      </button>
    </h2>
    <div id="${id}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="${headerId}" data-bs-parent="#accordionExercicios">
      <div class="accordion-body">
        <ul>
          ${(capitulo.exercicios || []).map(e => `<li><a href="${e}" target="_blank">${e.split('/').pop()}</a></li>`).join('') || '<li>Nenhum exercício</li>'}
        </ul>
        <form class="upload-form" data-capitulo-index="${index}" enctype="multipart/form-data">
          <input type="file" name="arquivo" accept="application/pdf" required />
          <button type="submit" class="btn btn-sm btn-success mt-2">Enviar Exercício (PDF)</button>
        </form>
      </div>
    </div>
  </div>
`;
});
                    const accordionVideos = document.getElementById('accordionVideos');
                    accordionVideos.innerHTML = '';

                    curso.capitulosVideos?.forEach((capitulo, index) => {
                        const id = `collapseVid${index}`;
                        const headerId = `headingVid${index}`;

                        accordionVideos.innerHTML += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headerId}">
                        <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse"
                            data-bs-target="#${id}" aria-expanded="${index === 0}" aria-controls="${id}">
                            ${capitulo.titulo}
                        </button>
                    </h2>
                    <div id="${id}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="${headerId}" data-bs-parent="#accordionVideos">
                        <div class="accordion-body">
                            <ul>
                                ${(capitulo.videos || []).map(v => `<li>${v}</li>`).join('') || '<li>Nenhum vídeo</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
                    });

                });
        })
            .catch(err => {
                console.error("Erro ao carregar capítulos:", err);
            });

    </script>


</body>

</html>